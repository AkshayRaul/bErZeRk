jQuery.fn.extend({mousewheel:function(a,b,c){return this.hover(function(){jQuery.event.mousewheel.giveFocus(this,a,b,c)},function(){jQuery.event.mousewheel.removeFocus(this)})},mousewheeldown:function(a,b){return this.mousewheel(function(){},a,b)},mousewheelup:function(a,b){return this.mousewheel(a,function(){},b)},unmousewheel:function(){return this.each(function(){jQuery(this).unmouseover().unmouseout();jQuery.event.mousewheel.removeFocus(this)})},unmousewheeldown:jQuery.fn.unmousewheel,unmousewheelup:jQuery.fn.unmousewheel});
jQuery.event.mousewheel={giveFocus:function(a,b,c,d){a._handleMousewheel&&jQuery(a).unmousewheel();d==window.undefined&&(c&&c.constructor!=Function)&&(d=c,c=null);a._handleMousewheel=function(e){if(!e)e=window.event;if(d)e.preventDefault?e.preventDefault():e.returnValue=false;var h=0;if(e.wheelDelta){h=e.wheelDelta/120;window.opera&&(h=-h)}else e.detail&&(h=-e.detail/3);b&&(h>0||!c)?b.apply(a,[e,h]):c&&h<0&&c.apply(a,[e,h])};window.addEventListener&&window.addEventListener("DOMMouseScroll",a._handleMousewheel,
!1);window.onmousewheel=document.onmousewheel=a._handleMousewheel},removeFocus:function(a){a._handleMousewheel&&(window.removeEventListener&&window.removeEventListener("DOMMouseScroll",a._handleMousewheel,!1),window.onmousewheel=document.onmousewheel=null,a._handleMousewheel=null)}};(function(){var a=!1,b=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;this.Class=function(){};Class.extend=function(c){function d(){!a&&this.init&&this.init.apply(this,arguments)}var e=this.prototype;a=!0;var h=new this;a=!1;for(var f in c)h[f]="function"==typeof c[f]&&"function"==typeof e[f]&&b.test(c[f])?function(a,c){return function(){var b=this._super;this._super=e[a];var d=c.apply(this,arguments);this._super=b;return d}}(f,c[f]):c[f];d.prototype=h;d.prototype.constructor=d;d.extend=arguments.callee;
return d}})();var GameScreen=Class.extend({init:function(a,b,c){this.game=a;this.scene=b;this.camera=c;this.level=1;this.lastLevel=4;this.cameraUpdate=!1;this.setup()},setup:function(){this.clearLevel();switch(this.level){case 1:this.size={x_min:-100,x_max:100,y_min:-80,y_max:80};this.stars=starField({scene:this.scene,stars:4E4,size:3});this.fruitsToEat=15;this.randomFruitSize=!0;this.cameraPosition={x:-120,y:-50,z:250};break;case 2:this.cameraPosition={x:0,y:0,z:120};this.size={x_min:-this.getXMax()+SNAKE.TILE_SIZE,
x_max:this.getXMax()-SNAKE.TILE_SIZE,y_min:-this.getYMax()+SNAKE.TILE_SIZE,y_max:this.getYMax()-SNAKE.TILE_SIZE};this.stars=starField({scene:this.scene,stars:5E4,size:2});this.fruitsToEat=15;this.randomFruitSize=!1;this.cameraUpdate=!0;break;case 3:this.size={x_min:-100,x_max:100,y_min:-40,y_max:40};this.stars=starField({scene:this.scene,stars:3E4,size:2});this.fruitsToEat=15;this.randomFruitSize=!0;this.cameraPosition={x:20,y:-120,z:300};this.cameraUpdate=!0;break;case 4:this.size={x_min:-100,x_max:100,
y_min:-40,y_max:40},this.stars=starField({scene:this.scene,stars:3E4,size:2}),this.fruitsToEat=15,this.randomFruitSize=!1,this.cameraPosition={x:20,y:50,z:340},this.cameraUpdate=!0}$("#info .level").html("Level "+this.level);this.cameraUpdate&&this.updateCamera();this.createWalls();this.player=player(this.scene,{x:this.size.x_min+32,y:this.size.y_min+16});this.addObstacles();this.xPositions=[];this.yPositions=[];for(var a=this.size.x_min+SNAKE.TILE_SIZE;a<this.size.x_max;a+=SNAKE.TILE_SIZE)this.xPositions.push(a);
for(a=this.size.y_min+SNAKE.TILE_SIZE;a<this.size.y_max;a+=SNAKE.TILE_SIZE)this.yPositions.push(a);this.fruit=this.createFruit();this.fruitsEaten=this.score=0;$("#info").show();this.setScore(0);this.levelFinished=!1;this.updateLevelGoal()},getXMax:function(a){a=2*this.cameraPosition.z*Math.tan(22.5*(Math.PI/180))*(SNAKE.WIDTH/SNAKE.HEIGHT)/2;for(a=Math.round(a);a--;)if(0==a%4)return a},getYMax:function(){for(var a=2*this.cameraPosition.z*Math.tan(22.5*(Math.PI/180))/2,a=Math.round(a);a--;)if(0==a%
4)return a},addObstacles:function(){this.obstacles=[];if(!(1<this.level)){for(var a=-52;52>a;a+=SNAKE.TILE_SIZE){var b={x:a,y:-40};this.obstacles.push(b);this.createWall(b)}for(a=-40;8>a;a+=SNAKE.TILE_SIZE)b={x:52,y:a},this.obstacles.push(b),this.createWall(b);for(a=-40;8>a;a+=SNAKE.TILE_SIZE)b={x:-52,y:a},this.obstacles.push(b),this.createWall(b);for(a=0;36>a;a+=SNAKE.TILE_SIZE)b={x:20,y:a},this.obstacles.push(b),this.createWall(b);for(a=0;36>a;a+=SNAKE.TILE_SIZE)b={x:-20,y:a},this.obstacles.push(b),
this.createWall(b)}},updateCamera:function(){this.camera.position.x=this.cameraPosition.x;this.camera.position.y=this.cameraPosition.y;this.camera.position.z=this.cameraPosition.z;this.camera.lookAt(this.scene.position)},clearLevel:function(){for(var a=this.scene.children.length,b=[],c=0;c<a;c++){var d=this.scene.children[c];"save-me"!==d.name&&b.push(d)}for(c=0;c<b.length;c++)this.scene.remove(b[c])},createWall:function(a){var b=255*Math.random()<<16|255*Math.random()<<8|255*Math.random(),c=new THREE.CubeGeometry(SNAKE.TILE_SIZE,
SNAKE.TILE_SIZE,Math.random()*SNAKE.TILE_SIZE+2),b=new THREE.MeshLambertMaterial({color:b}),c=new THREE.Mesh(c,b);c.position.x=a.x;c.position.y=a.y;this.scene.add(c);return c},createWalls:function(){for(var a=this.size.x_min;a<this.size.x_max;a+=SNAKE.TILE_SIZE)this.createWall({x:a,y:this.size.y_max}),this.createWall({x:a,y:this.size.y_min});for(a=this.size.y_min;a<this.size.y_max;a+=SNAKE.TILE_SIZE)this.createWall({x:this.size.x_min,y:a}),this.createWall({x:this.size.x_max,y:a})},getRandomPosition:function(){var a=
this.xPositions[Math.round(Math.random()*(this.xPositions.length-1))],b=this.yPositions[Math.round(Math.random()*(this.yPositions.length-1))];return{x:a,y:b}},createFruit:function(){for(var a;!(a=this.getRandomPosition(),this.okPosition(a)););return sphere({scene:this.scene,radius:this.randomFruitSize?5*Math.random()+5:2,mesh:0.5<Math.random()?!0:!1,x:a.x,y:a.y})},okPosition:function(a){for(var b=this.obstacles.length,c,d=0;d<b;d++)if(c=this.obstacles[d],c.x==a.x&&c.y==a.y)return!1;return!0},checkBounds:function(){var a=
this.player.getPosition();(a.x<this.size.x_min+SNAKE.TILE_SIZE||a.x>this.size.x_max-SNAKE.TILE_SIZE||a.y<this.size.y_min+SNAKE.TILE_SIZE||a.y>this.size.y_max-SNAKE.TILE_SIZE)&&this.player.die();for(var b=this.obstacles.length,c,d=0;d<b;d++)c=this.obstacles[d],c.x==a.x&&c.y==a.y&&this.player.die()},zeroPad:function(a,b){var c=b-a.toString().length+1;return Array(+(0<c&&c)).join("0")+a},setScore:function(a){$(".score").html(this.zeroPad(a,9))},updateLevelGoal:function(){var a=this.fruitsToEat-this.fruitsEaten;
if(0==a)if(this.levelFinished=!0,$("#goal").html("Woo! Done! :D"),this.level==this.lastLevel)$("#done").html("Well done! Game clear! Congratulations! :DD").show("slow");else{$("#done").html('Well done! Level cleared! <a href="javascript:;">Play next?</a>').show("slow");var b=this;$("#done a").click(function(){$("#done").hide("slow");b.level++;b.setup()})}else $("#goal").html("Eat "+a+" fruits!")},update:function(){this.stars.update();this.levelFinished||(this.fruit.update(),this.player.update(),this.player.collidesWith(this.fruit)&&
(this.score+=Math.round(1E3*this.fruit.getRadius()),this.setScore(this.score),this.fruitsEaten++,this.player.addBody(3),this.scene.remove(this.fruit.getMesh()),this.updateLevelGoal(),this.levelFinished||(this.fruit=this.createFruit())),this.checkBounds())}});var IntroScreen=Class.extend({init:function(a,b,c){this.stars=introStars({scene:b,camera:c,stars:4E4,size:3});this.planet=sphere({scene:b,radius:40,mesh:!0,x:-40,y:-5});$("#intro a").click(function(){$("#intro").hide("slow");a.setScreen(new GameScreen(a,b,c))})},update:function(){this.stars.update();this.planet.update()}});var introStars=function(a){for(var b={},c=a.scene,d=a.stars,e=a.size,h=new THREE.Geometry,a=0;a<d;a++){var f=new THREE.Vector3;f.x=1E3*Math.random()-500;f.y=1E3*Math.random()-500;f.z=1E3*Math.random()-500;h.vertices.push(f)}var k=new THREE.ParticleBasicMaterial({color:"0xffffff",map:THREE.ImageUtils.loadTexture(SNAKE.IMAGES+"/bubble.png"),depthTest:!1,blending:THREE.AdditiveBlending,transparent:1,opacity:1,size:e});k.color.setHSV(Math.random(),1,1);var j=new THREE.ParticleSystem(h,k);j.rotation.x=
15*Math.random();j.rotation.y=15*Math.random();j.rotation.z=15*Math.random();c.add(j);for(var d=new THREE.PlaneGeometry(5E3,5,1,1),m=new THREE.Object3D,a=0;10>a;a++)e=new THREE.MeshBasicMaterial({opacity:0.15,blending:THREE.AdditiveBlending,depthTest:!1}),e.color=new THREE.Color,e.color.setHSV(Math.random(),1,1),e=new THREE.Mesh(d,e),e.doubleSided=!0,e.rotation.x=Math.random()*Math.PI,e.rotation.y=Math.random()*Math.PI,e.rotation.z=Math.random()*Math.PI,m.add(e);c.add(m);b.update=function(){var a=
1E-5*Date.now();j.rotation.y=5E-5*Date.now();k.color.setHSV(a%1,1,1);m.rotation.x+=0.003;m.rotation.y+=0.003};return b};var player=function(a,b){var c={},d=playerInput();c.collidesWith=function(a){var c;if(c=a){var b=j[0].position,d=a.getPosition();c=d.x-b.x;b=d.y-b.y;c=Math.sqrt(c*c+b*b)<a.getRadius()}return c};c.addBody=function(a){q=!0;e=a;h-=0.002};var e,h=1/15,f=h,k=Date.now();c.update=function(){d.update();var b=Date.now(),l=(b-k)/1E3;k=b;f-=l;if(0>=f){f=h;if(r){b=j.length;for(l=0;l<b;l++){var g=j[l];g.position.x+=g.vx;g.position.y+=g.vy;g.position.z+=g.vz;g.rotation.x+=0.03}}else{b=j[0];d.buttons[d.BUTTON_UP]&&
0!=n&&1!=n?n=0:d.buttons[d.BUTTON_DOWN]&&0!=n&&1!=n?n=1:d.buttons[d.BUTTON_LEFT]&&2!=n&&3!=n?n=2:d.buttons[d.BUTTON_RIGHT]&&(2!=n&&3!=n)&&(n=3);if(q)for(l=0;l<e;l++)g=new THREE.Mesh(s,o),0==l&&(g.scale.set(1.5,1.5,1.5),g.name="scaled"),g.position.x=b.position.x,g.position.y=b.position.y,a.add(g),j.unshift(g),q=!1;l=j.pop();"scaled"===l.name&&(l.scale.set(1,1,1),l.name="");l.position.x=b.position.x;l.position.y=b.position.y;j.unshift(l);b=m;switch(n){case 0:l.position.y+=b;break;case 1:l.position.y-=
b;break;case 2:l.position.x-=b;break;case 3:l.position.x+=b}b=j[0];g=j.length;for(l=1;l<g;l++){var p=j[l];b.position.x==p.position.x&&b.position.y==p.position.y&&c.die()}}b=5E-5*Date.now();o.color.setHSV(b%1,1,1)}};c.die=function(){if(!r){var a=j.length,b=j[0];b.vx=0;b.vy=0;b.vz=4;for(b=1;b<a;b++){var c=j[b];c.vx=2*Math.random()*(0.5<Math.random()?-1:1);c.vy=2*Math.random()*(0.5<Math.random()?-1:1);c.vz=3*Math.random()*(0.5<Math.random()?-1:1)}r=!0;$("#gameover").show("slow")}};c.getPosition=function(){return{x:j[0].position.x,
y:j[0].position.y}};var j=[],m=4,g=255*Math.random()<<16|255*Math.random()<<8|255*Math.random(),o=new THREE.MeshLambertMaterial({color:g}),s=new THREE.CubeGeometry(m,m,m);new THREE.CubeGeometry(6,6,6);var n=3,q=!1,r=!1,g=new THREE.Mesh(s,o);g.position.x=b.x;g.position.y=b.y;a.add(g);j.push(g);for(g=0;4>g;g++){var p=new THREE.Mesh(s,o);p.position.x=j[g].position.x-m;p.position.y=j[g].position.y;a.add(p);j.push(p)}return c};var playerInput=function(){var a={buttons:[!1,!1,!1,!1]};oldButtons=[!1,!1,!1,!1];a.BUTTON_LEFT=0;a.BUTTON_RIGHT=1;a.BUTTON_UP=2;a.BUTTON_DOWN=3;var b=function(b,d){var e=-1;65===b&&(e=a.BUTTON_LEFT);68===b&&(e=a.BUTTON_RIGHT);87===b&&(e=a.BUTTON_UP);83===b&&(e=a.BUTTON_DOWN);38===b&&(e=a.BUTTON_UP);40===b&&(e=a.BUTTON_DOWN);37===b&&(e=a.BUTTON_LEFT);39===b&&(e=a.BUTTON_RIGHT);-1!=e&&(a.buttons[e]=d)};document.onkeydown=function(a){b(a.which,!0)};document.onkeyup=function(a){b(a.which,!1)};a.update=
function(){for(var b=0;b<a.buttons.length;b++)oldButtons[b]=a.buttons[b]};return a};var startGame=function(){var a={},b=new Stats;b.domElement.style.position="absolute";b.domElement.style.top="0px";b.domElement.style.right="5px";document.body.appendChild(b.domElement);var c=window.innerWidth-5,d=window.innerHeight-5,e=new THREE.WebGLRenderer({antialias:!0});e.setSize(c,d);$("#container").append(e.domElement);var h=new THREE.Scene;h.fog=new THREE.FogExp2(0,0.0011);var f=new THREE.PerspectiveCamera(45,c/d,0.1,1E4);f.name="save-me";f.position.x=-74;f.position.y=22;f.position.z=250;
f.lookAt(h.position);h.add(f);var k=500*Math.tan(22.5*(Math.PI/180)),j=k*(c/d),m=j/2,g=0-j/2,o=k/2,s=0-k/2;SNAKE={};SNAKE.WIDTH=c;SNAKE.HEIGHT=d;SNAKE.DISPLAY_WIDTH=j;SNAKE.DISPLAY_HEIGHT=k;SNAKE.X_MAX=m;SNAKE.X_MIN=g;SNAKE.Y_MAX=o;SNAKE.Y_MIN=s;SNAKE.TILE_SIZE=4;SNAKE.CAMERA_DEBUG=!0;SNAKE.IMAGES="/images";k=new THREE.PointLight(16777215);k.name="save-me";k.position.x=10;k.position.y=50;k.position.z=130;h.add(k);k=new THREE.DirectionalLight(16777215*Math.random());k.name="save-me";k.position.set(Math.random(),
Math.random(),Math.random()).normalize();h.add(k);k=new THREE.DirectionalLight(16777215*Math.random());k.name="save-me";k.position.set(Math.random(),Math.random(),Math.random()).normalize();h.add(k);var k=new THREE.LineBasicMaterial({color:16777215,opacity:0.2}),n=new THREE.Geometry;n.vertices.push(new THREE.Vector3(g,0,0));n.vertices.push(new THREE.Vector3(m,0,0));g=new THREE.Object3D;g.name="save-me";for(var q=2;q<o;q+=4)j=new THREE.Line(n,k),j.position.y=q,g.add(j);n=new THREE.Geometry;n.vertices.push(new THREE.Vector3(0,
o,0));n.vertices.push(new THREE.Vector3(0,s,0));for(o=2;o<m;o+=4)j=new THREE.Line(n,k),j.position.x=o,g.add(j);h.add(g);$("#intro").show();if(SNAKE.CAMERA_DEBUG){var r,p,t=0,l=!1,v=!1;$("canvas").mousemove(function(){r=event.clientX-c/2;p=event.clientY-d/2});$("canvas").mousedown(function(){document.body.style.cursor="move";l=!0;return!1});$("canvas").mouseup(function(){document.body.style.cursor="default";l=!1});$("canvas").mousewheel(function(a,b){v=!0;t+=b})}a.setScreen=function(a){w=a};var u=
function(){$("#debug").html("Camera: ("+f.position.x.toFixed(2)+", "+f.position.y.toFixed(2)+", "+f.position.z.toFixed(2)+")")};$("#gameover a").click(function(){$("#gameover").hide("slow");a.setScreen(new GameScreen(a,h,f))});var x=function(){requestAnimationFrame(x);w.update();if(SNAKE.CAMERA_DEBUG&&(l&&(f.position.x+=0.01*(r-f.position.x),f.position.y+=0.01*(-p-f.position.y),f.lookAt(h.position),u()),v))f.position.z=250+t,u();e.render(h,f);b.update()},w=new IntroScreen(a,h,f);u();requestAnimationFrame(x);
return a};$(document).ready(function(){Detector.webgl?startGame():Detector.addGetWebGLMessage()});var sphere=function(a){var b={},c=a.scene,d=a.radius||20*Math.random+5,e=a.mesh||!1,h=a.x,f=a.y,k=a.rotation||0.005,j=function(){var a=255*Math.random()<<16|255*Math.random()<<8|255*Math.random(),a=new THREE.MeshLambertMaterial({color:a,wireframe:e}),a=new THREE.Mesh(new THREE.SphereGeometry(d,30,30),a);a.position.x=h;a.position.y=f;a.radius=d;c.add(a);return a};b.refresh=function(){m=j()};b.update=function(){m.rotation.y+=k};b.getPosition=function(){return m.position};b.getRadius=function(){return m.radius};
b.getMesh=function(){return m};var m=j();return b};var starField=function(a){var b={},c=a.scene,d=a.stars,a=a.size,e=new THREE.Geometry;for(i=0;i<d;i++){var h=new THREE.Vector3;h.x=1E3*Math.random()-500;h.y=1E3*Math.random()-500;h.z=1E3*Math.random()-500;e.vertices.push(h)}var f=new THREE.ParticleBasicMaterial({color:"0xffffff",map:THREE.ImageUtils.loadTexture(SNAKE.IMAGES+"/bubble.png"),depthTest:!1,blending:THREE.AdditiveBlending,transparent:1,opacity:1,size:a});f.color.setHSV(Math.random(),1,1);var k=new THREE.ParticleSystem(e,f);k.rotation.x=
15*Math.random();k.rotation.y=15*Math.random();k.rotation.z=15*Math.random();c.add(k);b.update=function(){var a=1E-5*Date.now();k.rotation.y=5E-5*Date.now();f.color.setHSV(a%1,1,1)};return b};
