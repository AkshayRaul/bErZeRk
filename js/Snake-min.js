var GameScreen=Class.extend({init:function(a,b,c){this.game=a;this.scene=b;this.camera=c;this.level=1;this.lastLevel=4;this.cameraUpdate=!1;this.setup()},setup:function(){this.clearLevel();switch(this.level){case 1:this.size={x_min:-100,x_max:100,y_min:-80,y_max:80};this.stars=starField({scene:this.scene,stars:0,size:3});this.fruitsToEat=15;this.randomFruitSize=!0;this.cameraPosition={x:-120,y:-50,z:250};break;case 2:this.cameraPosition={x:0,y:0,z:120};this.size={x_min:-this.getXMax()+SNAKE.TILE_SIZE,
x_max:this.getXMax()-SNAKE.TILE_SIZE,y_min:-this.getYMax()+SNAKE.TILE_SIZE,y_max:this.getYMax()-SNAKE.TILE_SIZE};this.stars=starField({scene:this.scene,stars:5E4,size:2});this.fruitsToEat=15;this.randomFruitSize=!1;this.cameraUpdate=!0;break;case 3:this.size={x_min:-100,x_max:100,y_min:-40,y_max:40};this.stars=starField({scene:this.scene,stars:3E4,size:2});this.fruitsToEat=15;this.randomFruitSize=!0;this.cameraPosition={x:20,y:-120,z:300};this.cameraUpdate=!0;break;case 4:this.size={x_min:-100,x_max:100,
y_min:-40,y_max:40},this.stars=starField({scene:this.scene,stars:3E4,size:2}),this.fruitsToEat=15,this.randomFruitSize=!1,this.cameraPosition={x:20,y:50,z:340},this.cameraUpdate=!0}$("#info .level").html("Level "+this.level);this.cameraUpdate&&this.updateCamera();this.createWalls();this.player=player(this.scene,{x:this.size.x_min+32,y:this.size.y_min+16});this.addObstacles();this.xPositions=[];this.yPositions=[];for(var a=this.size.x_min+SNAKE.TILE_SIZE;a<this.size.x_max;a+=SNAKE.TILE_SIZE)this.xPositions.push(a);
for(a=this.size.y_min+SNAKE.TILE_SIZE;a<this.size.y_max;a+=SNAKE.TILE_SIZE)this.yPositions.push(a);this.fruit=this.createFruit();this.fruitsEaten=this.score=0;$("#info").show();this.setScore(0);this.levelFinished=!1;this.updateLevelGoal()},getXMax:function(a){a=2*this.cameraPosition.z*Math.tan(22.5*(Math.PI/180))*(SNAKE.WIDTH/SNAKE.HEIGHT)/2;for(a=Math.round(a);a--;)if(0==a%4)return a},getYMax:function(){for(var a=2*this.cameraPosition.z*Math.tan(22.5*(Math.PI/180))/2,a=Math.round(a);a--;)if(0==a%
4)return a},addObstacles:function(){this.obstacles=[];if(!(1<this.level)){for(var a=-52;52>a;a+=SNAKE.TILE_SIZE){var b={x:a,y:-40};this.obstacles.push(b);this.createWall(b)}for(a=-40;8>a;a+=SNAKE.TILE_SIZE)b={x:52,y:a},this.obstacles.push(b),this.createWall(b);for(a=-40;8>a;a+=SNAKE.TILE_SIZE)b={x:-52,y:a},this.obstacles.push(b),this.createWall(b);for(a=0;36>a;a+=SNAKE.TILE_SIZE)b={x:20,y:a},this.obstacles.push(b),this.createWall(b);for(a=0;36>a;a+=SNAKE.TILE_SIZE)b={x:-20,y:a},this.obstacles.push(b),
this.createWall(b)}},updateCamera:function(){this.camera.position.x=this.cameraPosition.x;this.camera.position.y=this.cameraPosition.y;this.camera.position.z=this.cameraPosition.z;this.camera.lookAt(this.scene.position)},clearLevel:function(){for(var a=this.scene.children.length,b=[],c=0;c<a;c++){var d=this.scene.children[c];"save-me"!==d.name&&b.push(d)}for(c=0;c<b.length;c++)this.scene.remove(b[c])},createWall:function(a){var b=255*Math.random()<<16|255*Math.random()<<8|255*Math.random(),c=new THREE.CubeGeometry(SNAKE.TILE_SIZE,
SNAKE.TILE_SIZE,Math.random()*SNAKE.TILE_SIZE+2),b=new THREE.MeshLambertMaterial({color:b}),c=new THREE.Mesh(c,b);c.position.x=a.x;c.position.y=a.y;this.scene.add(c);return c},createWalls:function(){for(var a=this.size.x_min;a<this.size.x_max;a+=SNAKE.TILE_SIZE)this.createWall({x:a,y:this.size.y_max}),this.createWall({x:a,y:this.size.y_min});for(a=this.size.y_min;a<this.size.y_max;a+=SNAKE.TILE_SIZE)this.createWall({x:this.size.x_min,y:a}),this.createWall({x:this.size.x_max,y:a})},getRandomPosition:function(){var a=
this.xPositions[Math.round(Math.random()*(this.xPositions.length-1))],b=this.yPositions[Math.round(Math.random()*(this.yPositions.length-1))];return{x:a,y:b}},createFruit:function(){for(var a;!(a=this.getRandomPosition(),this.okPosition(a)););return sphere({scene:this.scene,radius:this.randomFruitSize?5*Math.random()+5:2,mesh:0.5<Math.random()?!0:!1,x:a.x,y:a.y})},okPosition:function(a){for(var b=this.obstacles.length,c,d=0;d<b;d++)if(c=this.obstacles[d],c.x==a.x&&c.y==a.y)return!1;return!0},checkBounds:function(){var a=
this.player.getPosition();(a.x<this.size.x_min+SNAKE.TILE_SIZE||a.x>this.size.x_max-SNAKE.TILE_SIZE||a.y<this.size.y_min+SNAKE.TILE_SIZE||a.y>this.size.y_max-SNAKE.TILE_SIZE)&&this.player.die();for(var b=this.obstacles.length,c,d=0;d<b;d++)c=this.obstacles[d],c.x==a.x&&c.y==a.y&&this.player.die()},zeroPad:function(a,b){var c=b-a.toString().length+1;return Array(+(0<c&&c)).join("0")+a},setScore:function(a){$(".score").html(this.zeroPad(a,9))},updateLevelGoal:function(){var a=this.fruitsToEat-this.fruitsEaten;
if(0==a)if(this.levelFinished=!0,$("#goal").html("Woo! Done! :D"),this.level==this.lastLevel)$("#done").html("Well done! Game clear! Congratulations! :DD").show("slow");else{$("#done").html('Well done! Level cleared! <a href="javascript:;">Play next?</a>').show("slow");var b=this;$("#done a").click(function(){$("#done").hide("slow");b.level++;b.setup()})}else $("#goal").html("Eat "+a+" fruits!")},update:function(){this.stars.update();this.levelFinished||(this.fruit.update(),this.player.update(),this.player.collidesWith(this.fruit)&&
(this.score+=Math.round(1E3*this.fruit.getRadius()),this.setScore(this.score),this.fruitsEaten++,this.player.addBody(3),this.scene.remove(this.fruit.getMesh()),this.updateLevelGoal(),this.levelFinished||(this.fruit=this.createFruit())),this.checkBounds())}}),IntroScreen=Class.extend({init:function(a,b,c){this.stars=introStars({scene:b,camera:c,stars:4E4,size:3});this.planet=sphere({scene:b,radius:40,mesh:!0,x:-40,y:-5});$("#intro a").click(function(){$("#intro").hide("slow");a.setScreen(new GameScreen(a,
b,c))})},update:function(){this.stars.update();this.planet.update()}}),introStars=function(){},playerInput=function(){var a={buttons:[!1,!1,!1,!1]};oldButtons=[!1,!1,!1,!1];a.BUTTON_LEFT=0;a.BUTTON_RIGHT=1;a.BUTTON_UP=2;a.BUTTON_DOWN=3;var b=function(c,b){var l=-1;65===c&&(l=a.BUTTON_LEFT);68===c&&(l=a.BUTTON_RIGHT);87===c&&(l=a.BUTTON_UP);83===c&&(l=a.BUTTON_DOWN);38===c&&(l=a.BUTTON_UP);40===c&&(l=a.BUTTON_DOWN);37===c&&(l=a.BUTTON_LEFT);39===c&&(l=a.BUTTON_RIGHT);-1!=l&&(a.buttons[l]=b)};document.onkeydown=
function(a){b(a.which,!0)};document.onkeyup=function(a){b(a.which,!1)};a.update=function(){for(var c=0;c<a.buttons.length;c++)oldButtons[c]=a.buttons[c]};return a},player=function(a,b){var c={},d=playerInput();c.collidesWith=function(a){var c;if(c=a){var b=e[0].position,d=a.getPosition();c=d.x-b.x;b=d.y-b.y;c=Math.sqrt(c*c+b*b)<a.getRadius()}return c};c.addBody=function(a){r=!0;l=a;k-=0.002};var l,k=1/15,j=k,f=Date.now();c.update=function(){d.update();var b=Date.now(),g=(b-f)/1E3;f=b;j-=g;if(0>=j){j=
k;if(s){b=e.length;for(g=0;g<b;g++){var p=e[g];p.position.x+=p.vx;p.position.y+=p.vy;p.position.z+=p.vz;p.rotation.x+=0.03}}else{b=e[0];d.buttons[d.BUTTON_UP]&&0!=m&&1!=m?m=0:d.buttons[d.BUTTON_DOWN]&&0!=m&&1!=m?m=1:d.buttons[d.BUTTON_LEFT]&&2!=m&&3!=m?m=2:d.buttons[d.BUTTON_RIGHT]&&2!=m&&3!=m&&(m=3);if(r)for(g=0;g<l;g++)p=new THREE.Mesh(t,o),0==g&&(p.scale.set(1.5,1.5,1.5),p.name="scaled"),p.position.x=b.position.x,p.position.y=b.position.y,a.add(p),e.unshift(p),r=!1;g=e.pop();"scaled"===g.name&&
(g.scale.set(1,1,1),g.name="");g.position.x=b.position.x;g.position.y=b.position.y;e.unshift(g);b=n;switch(m){case 0:g.position.y+=b;break;case 1:g.position.y-=b;break;case 2:g.position.x-=b;break;case 3:g.position.x+=b}b=e[0];p=e.length;for(g=1;g<p;g++){var h=e[g];b.position.x==h.position.x&&b.position.y==h.position.y&&c.die()}}b=5E-5*Date.now();o.color.setHSV(b%1,1,1)}};c.die=function(){if(!s){var a=e.length,b=e[0];b.vx=0;b.vy=0;b.vz=4;for(b=1;b<a;b++){var c=e[b];c.vx=2*Math.random()*(0.5<Math.random()?
-1:1);c.vy=2*Math.random()*(0.5<Math.random()?-1:1);c.vz=3*Math.random()*(0.5<Math.random()?-1:1)}s=!0;$("#gameover").show("slow")}};c.getPosition=function(){return{x:e[0].position.x,y:e[0].position.y}};var e=[],n=4,h=255*Math.random()<<16|255*Math.random()<<8|255*Math.random(),o=new THREE.MeshLambertMaterial({color:h}),t=new THREE.CubeGeometry(n,n,n);new THREE.CubeGeometry(6,6,6);var m=3,r=!1,s=!1,h=new THREE.Mesh(t,o);h.position.x=b.x;h.position.y=b.y;a.add(h);e.push(h);for(h=0;4>h;h++){var q=new THREE.Mesh(t,
o);q.position.x=e[h].position.x-n;q.position.y=e[h].position.y;a.add(q);e.push(q)}return c},startGame=function(){var a={},b=new Stats;b.domElement.style.position="absolute";b.domElement.style.top="0px";b.domElement.style.right="5px";document.body.appendChild(b.domElement);var c=window.innerWidth-5,d=window.innerHeight-5,l=new THREE.WebGLRenderer({antialias:!0});l.setSize(c,d);$("#container").append(l.domElement);var k=new THREE.Scene;k.fog=new THREE.FogExp2(0,0.0011);var j=new THREE.PerspectiveCamera(45,
c/d,0.1,1E4);j.name="save-me";j.position.x=-74;j.position.y=22;j.position.z=250;j.lookAt(k.position);k.add(j);var f=500*Math.tan(22.5*(Math.PI/180)),e=f*(c/d),n=e/2,h=0-e/2,o=f/2,t=0-f/2;SNAKE={};SNAKE.WIDTH=c;SNAKE.HEIGHT=d;SNAKE.DISPLAY_WIDTH=e;SNAKE.DISPLAY_HEIGHT=f;SNAKE.X_MAX=n;SNAKE.X_MIN=h;SNAKE.Y_MAX=o;SNAKE.Y_MIN=t;SNAKE.TILE_SIZE=4;SNAKE.CAMERA_DEBUG=!0;SNAKE.IMAGES="/images/";f=new THREE.PointLight(16777215);f.name="save-me";f.position.x=10;f.position.y=50;f.position.z=130;k.add(f);f=new THREE.DirectionalLight(16777215*
Math.random());f.name="save-me";f.position.set(Math.random(),Math.random(),Math.random()).normalize();k.add(f);f=new THREE.DirectionalLight(16777215*Math.random());f.name="save-me";f.position.set(Math.random(),Math.random(),Math.random()).normalize();k.add(f);var f=new THREE.LineBasicMaterial({color:16777215,opacity:0.2}),m=new THREE.Geometry;m.vertices.push(new THREE.Vector3(h,0,0));m.vertices.push(new THREE.Vector3(n,0,0));h=new THREE.Object3D;h.name="save-me";for(var r=2;r<o;r+=4)e=new THREE.Line(m,
f),e.position.y=r,h.add(e);m=new THREE.Geometry;m.vertices.push(new THREE.Vector3(0,o,0));m.vertices.push(new THREE.Vector3(0,t,0));for(o=2;o<n;o+=4)e=new THREE.Line(m,f),e.position.x=o,h.add(e);k.add(h);$("#intro").show();if(SNAKE.CAMERA_DEBUG){var s,q,v=!1,g=!1;$("canvas").mousemove(function(){s=event.clientX-c/2;q=event.clientY-d/2});$("canvas").mousewheel(function(){g=!0})}a.setScreen=function(a){u=a};$("#gameover a").click(function(){$("#gameover").hide("slow");a.setScreen(new GameScreen(a,k,
j))});var p=function(){requestAnimationFrame(p);u.update();if(SNAKE.CAMERA_DEBUG&&(v&&(j.position.x+=0.01*(s-j.position.x),j.position.y+=0.01*(-q-j.position.y),j.lookAt(k.position),updateCamera()),g))j.position.z=250,updateCamera();l.render(k,j);b.update()},u=new IntroScreen(a,k,j);requestAnimationFrame(p);return a};$(document).ready(function(){Detector.webgl?startGame():Detector.addGetWebGLMessage()});
var sphere=function(a){var b={},c=a.scene,d=a.radius||20*Math.random+5,l=a.mesh||!1,k=a.x,j=a.y,f=a.rotation||0.005,e=function(){var a=255*Math.random()<<16|255*Math.random()<<8|255*Math.random(),a=new THREE.MeshLambertMaterial({color:a,wireframe:l}),a=new THREE.Mesh(new THREE.SphereGeometry(d,30,30),a);a.position.x=k;a.position.y=j;a.radius=d;c.add(a);return a};b.refresh=function(){n=e()};b.update=function(){n.rotation.y+=f};b.getPosition=function(){return n.position};b.getRadius=function(){return n.radius};
b.getMesh=function(){return n};var n=e();return b},starField=function(a){var b={},c=a.scene,d=a.stars,a=a.size,l=new THREE.Geometry;for(i=0;i<d;i++){var k=new THREE.Vector3;k.x=1E3*Math.random()-500;k.y=1E3*Math.random()-500;k.z=1E3*Math.random()-500;l.vertices.push(k)}var j=new THREE.ParticleBasicMaterial({color:"0xffffff",map:THREE.ImageUtils.loadTexture(SNAKE.IMAGES+"/bubble.png"),depthTest:!1,blending:THREE.AdditiveBlending,transparent:1,opacity:1,size:a});j.color.setHSV(Math.random(),1,1);var f=
new THREE.ParticleSystem(l,j);f.rotation.x=15*Math.random();f.rotation.y=15*Math.random();f.rotation.z=15*Math.random();c.add(f);b.update=function(){var a=1E-5*Date.now();f.rotation.y=5E-5*Date.now();j.color.setHSV(a%1,1,1)};return b};GameScreen=Class.extend({init:function(a,b,c){this.game=a;this.scene=b;this.camera=c;this.level=1;this.lastLevel=4;this.cameraUpdate=!1;this.setup()},setup:function(){this.clearLevel();switch(this.level){case 1:this.size={x_min:-100,x_max:100,y_min:-80,y_max:80};this.stars=starField({scene:this.scene,stars:0,size:3});this.fruitsToEat=15;this.randomFruitSize=!0;this.cameraPosition={x:-120,y:-50,z:250};break;case 2:this.cameraPosition={x:0,y:0,z:120};this.size={x_min:-this.getXMax()+SNAKE.TILE_SIZE,
x_max:this.getXMax()-SNAKE.TILE_SIZE,y_min:-this.getYMax()+SNAKE.TILE_SIZE,y_max:this.getYMax()-SNAKE.TILE_SIZE};this.stars=starField({scene:this.scene,stars:5E4,size:2});this.fruitsToEat=15;this.randomFruitSize=!1;this.cameraUpdate=!0;break;case 3:this.size={x_min:-100,x_max:100,y_min:-40,y_max:40};this.stars=starField({scene:this.scene,stars:3E4,size:2});this.fruitsToEat=15;this.randomFruitSize=!0;this.cameraPosition={x:20,y:-120,z:300};this.cameraUpdate=!0;break;case 4:this.size={x_min:-100,x_max:100,
y_min:-40,y_max:40},this.stars=starField({scene:this.scene,stars:3E4,size:2}),this.fruitsToEat=15,this.randomFruitSize=!1,this.cameraPosition={x:20,y:50,z:340},this.cameraUpdate=!0}$("#info .level").html("Level "+this.level);this.cameraUpdate&&this.updateCamera();this.createWalls();this.player=player(this.scene,{x:this.size.x_min+32,y:this.size.y_min+16});this.addObstacles();this.xPositions=[];this.yPositions=[];for(var a=this.size.x_min+SNAKE.TILE_SIZE;a<this.size.x_max;a+=SNAKE.TILE_SIZE)this.xPositions.push(a);
for(a=this.size.y_min+SNAKE.TILE_SIZE;a<this.size.y_max;a+=SNAKE.TILE_SIZE)this.yPositions.push(a);this.fruit=this.createFruit();this.fruitsEaten=this.score=0;$("#info").show();this.setScore(0);this.levelFinished=!1;this.updateLevelGoal()},getXMax:function(a){a=2*this.cameraPosition.z*Math.tan(22.5*(Math.PI/180))*(SNAKE.WIDTH/SNAKE.HEIGHT)/2;for(a=Math.round(a);a--;)if(0==a%4)return a},getYMax:function(){for(var a=2*this.cameraPosition.z*Math.tan(22.5*(Math.PI/180))/2,a=Math.round(a);a--;)if(0==a%
4)return a},addObstacles:function(){this.obstacles=[];if(!(1<this.level)){for(var a=-52;52>a;a+=SNAKE.TILE_SIZE){var b={x:a,y:-40};this.obstacles.push(b);this.createWall(b)}for(a=-40;8>a;a+=SNAKE.TILE_SIZE)b={x:52,y:a},this.obstacles.push(b),this.createWall(b);for(a=-40;8>a;a+=SNAKE.TILE_SIZE)b={x:-52,y:a},this.obstacles.push(b),this.createWall(b);for(a=0;36>a;a+=SNAKE.TILE_SIZE)b={x:20,y:a},this.obstacles.push(b),this.createWall(b);for(a=0;36>a;a+=SNAKE.TILE_SIZE)b={x:-20,y:a},this.obstacles.push(b),
this.createWall(b)}},updateCamera:function(){this.camera.position.x=this.cameraPosition.x;this.camera.position.y=this.cameraPosition.y;this.camera.position.z=this.cameraPosition.z;this.camera.lookAt(this.scene.position)},clearLevel:function(){for(var a=this.scene.children.length,b=[],c=0;c<a;c++){var d=this.scene.children[c];"save-me"!==d.name&&b.push(d)}for(c=0;c<b.length;c++)this.scene.remove(b[c])},createWall:function(a){var b=255*Math.random()<<16|255*Math.random()<<8|255*Math.random(),c=new THREE.CubeGeometry(SNAKE.TILE_SIZE,
SNAKE.TILE_SIZE,Math.random()*SNAKE.TILE_SIZE+2),b=new THREE.MeshLambertMaterial({color:b}),c=new THREE.Mesh(c,b);c.position.x=a.x;c.position.y=a.y;this.scene.add(c);return c},createWalls:function(){for(var a=this.size.x_min;a<this.size.x_max;a+=SNAKE.TILE_SIZE)this.createWall({x:a,y:this.size.y_max}),this.createWall({x:a,y:this.size.y_min});for(a=this.size.y_min;a<this.size.y_max;a+=SNAKE.TILE_SIZE)this.createWall({x:this.size.x_min,y:a}),this.createWall({x:this.size.x_max,y:a})},getRandomPosition:function(){var a=
this.xPositions[Math.round(Math.random()*(this.xPositions.length-1))],b=this.yPositions[Math.round(Math.random()*(this.yPositions.length-1))];return{x:a,y:b}},createFruit:function(){for(var a;!(a=this.getRandomPosition(),this.okPosition(a)););return sphere({scene:this.scene,radius:this.randomFruitSize?5*Math.random()+5:2,mesh:0.5<Math.random()?!0:!1,x:a.x,y:a.y})},okPosition:function(a){for(var b=this.obstacles.length,c,d=0;d<b;d++)if(c=this.obstacles[d],c.x==a.x&&c.y==a.y)return!1;return!0},checkBounds:function(){var a=
this.player.getPosition();(a.x<this.size.x_min+SNAKE.TILE_SIZE||a.x>this.size.x_max-SNAKE.TILE_SIZE||a.y<this.size.y_min+SNAKE.TILE_SIZE||a.y>this.size.y_max-SNAKE.TILE_SIZE)&&this.player.die();for(var b=this.obstacles.length,c,d=0;d<b;d++)c=this.obstacles[d],c.x==a.x&&c.y==a.y&&this.player.die()},zeroPad:function(a,b){var c=b-a.toString().length+1;return Array(+(0<c&&c)).join("0")+a},setScore:function(a){$(".score").html(this.zeroPad(a,9))},updateLevelGoal:function(){var a=this.fruitsToEat-this.fruitsEaten;
if(0==a)if(this.levelFinished=!0,$("#goal").html("Woo! Done! :D"),this.level==this.lastLevel)$("#done").html("Well done! Game clear! Congratulations! :DD").show("slow");else{$("#done").html('Well done! Level cleared! <a href="javascript:;">Play next?</a>').show("slow");var b=this;$("#done a").click(function(){$("#done").hide("slow");b.level++;b.setup()})}else $("#goal").html("Eat "+a+" fruits!")},update:function(){this.stars.update();this.levelFinished||(this.fruit.update(),this.player.update(),this.player.collidesWith(this.fruit)&&
(this.score+=Math.round(1E3*this.fruit.getRadius()),this.setScore(this.score),this.fruitsEaten++,this.player.addBody(3),this.scene.remove(this.fruit.getMesh()),this.updateLevelGoal(),this.levelFinished||(this.fruit=this.createFruit())),this.checkBounds())}});IntroScreen=Class.extend({init:function(a,b,c){this.stars=introStars({scene:b,camera:c,stars:4E4,size:3});this.planet=sphere({scene:b,radius:40,mesh:!0,x:-40,y:-5});$("#intro a").click(function(){$("#intro").hide("slow");a.setScreen(new GameScreen(a,b,c))})},update:function(){this.stars.update();this.planet.update()}});introStars=function(){};playerInput=function(){var a={buttons:[!1,!1,!1,!1]};oldButtons=[!1,!1,!1,!1];a.BUTTON_LEFT=0;a.BUTTON_RIGHT=1;a.BUTTON_UP=2;a.BUTTON_DOWN=3;var b=function(b,d){var l=-1;65===b&&(l=a.BUTTON_LEFT);68===b&&(l=a.BUTTON_RIGHT);87===b&&(l=a.BUTTON_UP);83===b&&(l=a.BUTTON_DOWN);38===b&&(l=a.BUTTON_UP);40===b&&(l=a.BUTTON_DOWN);37===b&&(l=a.BUTTON_LEFT);39===b&&(l=a.BUTTON_RIGHT);-1!=l&&(a.buttons[l]=d)};document.onkeydown=function(a){b(a.which,!0)};document.onkeyup=function(a){b(a.which,!1)};a.update=function(){for(var b=
0;b<a.buttons.length;b++)oldButtons[b]=a.buttons[b]};return a};player=function(a,b){var c={},d=playerInput();c.collidesWith=function(a){var b;if(b=a){var c=e[0].position,d=a.getPosition();b=d.x-c.x;c=d.y-c.y;b=Math.sqrt(b*b+c*c)<a.getRadius()}return b};c.addBody=function(a){r=!0;l=a;k-=0.002};var l,k=1/15,j=k,f=Date.now();c.update=function(){d.update();var b=Date.now(),g=(b-f)/1E3;f=b;j-=g;if(0>=j){j=k;if(s){b=e.length;for(g=0;g<b;g++){var h=e[g];h.position.x+=h.vx;h.position.y+=h.vy;h.position.z+=h.vz;h.rotation.x+=0.03}}else{b=e[0];d.buttons[d.BUTTON_UP]&&
0!=m&&1!=m?m=0:d.buttons[d.BUTTON_DOWN]&&0!=m&&1!=m?m=1:d.buttons[d.BUTTON_LEFT]&&2!=m&&3!=m?m=2:d.buttons[d.BUTTON_RIGHT]&&(2!=m&&3!=m)&&(m=3);if(r)for(g=0;g<l;g++)h=new THREE.Mesh(t,o),0==g&&(h.scale.set(1.5,1.5,1.5),h.name="scaled"),h.position.x=b.position.x,h.position.y=b.position.y,a.add(h),e.unshift(h),r=!1;g=e.pop();"scaled"===g.name&&(g.scale.set(1,1,1),g.name="");g.position.x=b.position.x;g.position.y=b.position.y;e.unshift(g);b=n;switch(m){case 0:g.position.y+=b;break;case 1:g.position.y-=
b;break;case 2:g.position.x-=b;break;case 3:g.position.x+=b}b=e[0];h=e.length;for(g=1;g<h;g++){var q=e[g];b.position.x==q.position.x&&b.position.y==q.position.y&&c.die()}}b=5E-5*Date.now();o.color.setHSV(b%1,1,1)}};c.die=function(){if(!s){var a=e.length,b=e[0];b.vx=0;b.vy=0;b.vz=4;for(b=1;b<a;b++){var c=e[b];c.vx=2*Math.random()*(0.5<Math.random()?-1:1);c.vy=2*Math.random()*(0.5<Math.random()?-1:1);c.vz=3*Math.random()*(0.5<Math.random()?-1:1)}s=!0;$("#gameover").show("slow")}};c.getPosition=function(){return{x:e[0].position.x,
y:e[0].position.y}};var e=[],n=4,h=255*Math.random()<<16|255*Math.random()<<8|255*Math.random(),o=new THREE.MeshLambertMaterial({color:h}),t=new THREE.CubeGeometry(n,n,n);new THREE.CubeGeometry(6,6,6);var m=3,r=!1,s=!1,h=new THREE.Mesh(t,o);h.position.x=b.x;h.position.y=b.y;a.add(h);e.push(h);for(h=0;4>h;h++){var q=new THREE.Mesh(t,o);q.position.x=e[h].position.x-n;q.position.y=e[h].position.y;a.add(q);e.push(q)}return c};startGame=function(){var a={},b=new Stats;b.domElement.style.position="absolute";b.domElement.style.top="0px";b.domElement.style.right="5px";document.body.appendChild(b.domElement);var c=window.innerWidth-5,d=window.innerHeight-5,l=new THREE.WebGLRenderer({antialias:!0});l.setSize(c,d);$("#container").append(l.domElement);var k=new THREE.Scene;k.fog=new THREE.FogExp2(0,0.0011);var j=new THREE.PerspectiveCamera(45,c/d,0.1,1E4);j.name="save-me";j.position.x=-74;j.position.y=22;j.position.z=250;j.lookAt(k.position);
k.add(j);var f=500*Math.tan(22.5*(Math.PI/180)),e=f*(c/d),n=e/2,h=0-e/2,o=f/2,t=0-f/2;SNAKE={};SNAKE.WIDTH=c;SNAKE.HEIGHT=d;SNAKE.DISPLAY_WIDTH=e;SNAKE.DISPLAY_HEIGHT=f;SNAKE.X_MAX=n;SNAKE.X_MIN=h;SNAKE.Y_MAX=o;SNAKE.Y_MIN=t;SNAKE.TILE_SIZE=4;SNAKE.CAMERA_DEBUG=!0;SNAKE.IMAGES="/images/";f=new THREE.PointLight(16777215);f.name="save-me";f.position.x=10;f.position.y=50;f.position.z=130;k.add(f);f=new THREE.DirectionalLight(16777215*Math.random());f.name="save-me";f.position.set(Math.random(),Math.random(),
Math.random()).normalize();k.add(f);f=new THREE.DirectionalLight(16777215*Math.random());f.name="save-me";f.position.set(Math.random(),Math.random(),Math.random()).normalize();k.add(f);var f=new THREE.LineBasicMaterial({color:16777215,opacity:0.2}),m=new THREE.Geometry;m.vertices.push(new THREE.Vector3(h,0,0));m.vertices.push(new THREE.Vector3(n,0,0));h=new THREE.Object3D;h.name="save-me";for(var r=2;r<o;r+=4)e=new THREE.Line(m,f),e.position.y=r,h.add(e);m=new THREE.Geometry;m.vertices.push(new THREE.Vector3(0,
o,0));m.vertices.push(new THREE.Vector3(0,t,0));for(o=2;o<n;o+=4)e=new THREE.Line(m,f),e.position.x=o,h.add(e);k.add(h);$("#intro").show();if(SNAKE.CAMERA_DEBUG){var s,q,v=!1,g=!1;$("canvas").mousemove(function(){s=event.clientX-c/2;q=event.clientY-d/2});$("canvas").mousewheel(function(){g=!0})}a.setScreen=function(a){u=a};$("#gameover a").click(function(){$("#gameover").hide("slow");a.setScreen(new GameScreen(a,k,j))});var p=function(){requestAnimationFrame(p);u.update();if(SNAKE.CAMERA_DEBUG&&(v&&
(j.position.x+=0.01*(s-j.position.x),j.position.y+=0.01*(-q-j.position.y),j.lookAt(k.position),updateCamera()),g))j.position.z=250,updateCamera();l.render(k,j);b.update()},u=new IntroScreen(a,k,j);requestAnimationFrame(p);return a};$(document).ready(function(){Detector.webgl?startGame():Detector.addGetWebGLMessage()});sphere=function(a){var b={},c=a.scene,d=a.radius||20*Math.random+5,l=a.mesh||!1,k=a.x,j=a.y,f=a.rotation||0.005,e=function(){var a=255*Math.random()<<16|255*Math.random()<<8|255*Math.random(),a=new THREE.MeshLambertMaterial({color:a,wireframe:l}),a=new THREE.Mesh(new THREE.SphereGeometry(d,30,30),a);a.position.x=k;a.position.y=j;a.radius=d;c.add(a);return a};b.refresh=function(){n=e()};b.update=function(){n.rotation.y+=f};b.getPosition=function(){return n.position};b.getRadius=function(){return n.radius};
b.getMesh=function(){return n};var n=e();return b};starField=function(a){var b={},c=a.scene,d=a.stars,a=a.size,l=new THREE.Geometry;for(i=0;i<d;i++){var k=new THREE.Vector3;k.x=1E3*Math.random()-500;k.y=1E3*Math.random()-500;k.z=1E3*Math.random()-500;l.vertices.push(k)}var j=new THREE.ParticleBasicMaterial({color:"0xffffff",map:THREE.ImageUtils.loadTexture(SNAKE.IMAGES+"/bubble.png"),depthTest:!1,blending:THREE.AdditiveBlending,transparent:1,opacity:1,size:a});j.color.setHSV(Math.random(),1,1);var f=new THREE.ParticleSystem(l,j);f.rotation.x=15*Math.random();
f.rotation.y=15*Math.random();f.rotation.z=15*Math.random();c.add(f);b.update=function(){var a=1E-5*Date.now();f.rotation.y=5E-5*Date.now();j.color.setHSV(a%1,1,1)};return b};
